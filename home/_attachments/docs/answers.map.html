<!DOCTYPE html>  <html> <head>   <title>answers.map.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="answers.map.html">                 answers.map.coffee               </a>                                           <a class="source" href="answers.reduce.html">                 answers.reduce.coffee               </a>                                           <a class="source" href="jquery.couch.ig.html">                 jquery.couch.ig.coffee               </a>                                           <a class="source" href="startup.html">                 startup.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               answers.map.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nf">(doc)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><code>// !code _attachments/scripts/hashUp.js
</code></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Plan of Action:</p>

<ul>
<li>Traverse the doc and get an array of its referenced docs' ids.
Every element in this array has the liberty to be present in 
the query or not. Lets call this array <code>idlist</code></li>
<li>There will be (2^n - 1) query possibilities to be satisfied by
<code>idlist</code> where n is the <code>idlist.length</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">docs = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">docs</span>
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>traverse</code> goes through a doc and returns the mentioned array</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">traverse = </span><span class="nf">(doc, arr)-&gt;</span>
    <span class="k">if</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;relation&quot;</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span> <span class="nx">docs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">subject</span><span class="p">].</span><span class="nx">_id</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span> <span class="nx">docs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">predicate</span><span class="p">].</span><span class="nx">_id</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span> <span class="nx">docs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">object</span><span class="p">].</span><span class="nx">_id</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The order of the docids is determined by breadth-first traversal
of the doc (subject, then predicate, then object, then subject docs, etc)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">traverse</span> <span class="nx">docs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">object</span><span class="p">],</span>
        <span class="nx">traverse</span> <span class="nx">docs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">predicate</span><span class="p">],</span>
          <span class="nx">traverse</span> <span class="nx">docs</span><span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">subject</span><span class="p">],</span> <span class="nx">arr</span>
    <span class="k">else</span>
      <span class="nx">arr</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The doc supplied to the view needs to be a relation</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;relation&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>If so, we can build <code>idlist</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">idlist = </span><span class="nx">traverse</span> <span class="nx">doc</span><span class="p">,</span> <span class="p">[]</span>
    <span class="nv">n = </span><span class="nx">idlist</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>and for all numbers from 1 to 2^n - 1</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">n</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>we get their binary representation (padded to length n)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">str = </span><span class="nx">i</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="nv">str = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Now this binary representation <code>str</code> is basically the code about
what spos we should make <code>null</code> in each of these 2^n-1 queries</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Initialise query array</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">query = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Initialise answer array</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">answer = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We will now fill these two arrays with appropriate docids. Note that 
the length of <code>query</code> and <code>answer</code> won't be <code>n</code> for every <code>str</code>
because if a subject somewhere is rendered <code>null</code> by <code>str</code>,
then its own doc tree (if it was a relation itself) has to vanish 
from <code>query</code> and the subject doc itself, then, will be part of <code>answer</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">str</span>
        <span class="k">if</span> <span class="nx">c</span> <span class="o">is</span> <span class="s2">&quot;0&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Lets take <code>0</code> to be the code for <code>null</code> in query,
and hence, we put a docid in <code>answer</code> at the appropriate place</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">answer</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">idlist</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>And for <code>1</code> in the binary representation we put a docid in <code>query</code></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">query</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">idlist</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>TODO: Incomplete</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 